<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Guacamole connection</title>
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/sweetalert/sweetalert2.min.css' %}">
</head>
<body>
<!--<h1>Guacamole Remote Desktop</h1>-->
<!-- Guacamole -->
<script type="text/javascript" src="{% static 'plugins/guacamole/all.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/sweetalert/sweetalert2.all.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/mousetrap/mousetrap.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/clipboard.js/clipboard.min.js' %}"></script>
<!-- Display -->
<div id="display">
</div>
<!-- Init -->
<script type="text/javascript"> /* <![CDATA[ */

// convert unicode
function encodeUnicode(str) {
    var res = [];
    for ( var i=0; i<str.length; i++ ) {
    res[i] = ( "00" + str.charCodeAt(i).toString(16) ).slice(-4);
    }
    return "\\u" + res.join("\\u");
}

// decode unicode
function decodeUnicode(str) {
    str = str.replace(/\\/g, "%");
    return unescape(str);
}
    // Get display div from document
    var display = document.getElementById("display");

    // Instantiate client, using an HTTP tunnel for communications.
    //http://guacamole.apache.org/doc/guacamole-common-js/Guacamole.WebSocketTunnel.html
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var ws_path = ws_scheme + '://' + window.location.host + '/guacamole/{{id}}/';
    var guac = new Guacamole.Client(
       // new Guacamole.HTTPTunnel("tunnel")
        new Guacamole.WebSocketTunnel(ws_path)
    );

    // Add client to display div
    display.appendChild(guac.getDisplay().getElement());

    // Error handler
    guac.onerror = function(error) {
        <!--alert(error);-->
        console.log(error);
    };

    // Connect
    guac.connect();

    // Disconnect on close
    window.onunload = function() {
        guac.disconnect();
    }
    guac.onclipboard = function(stream, mimetype){
        var f;
        if (/^text\//.exec(mimetype)) {
            f = new Guacamole.StringReader(stream);
            var e = "";
            f.ontext = function (a) {
                e += a
            };
            f.onend = function () {
                //console.log(3,e);
                //guac.setClipboard = e;
                <!--document.querySelector('textarea').select();-->
                document.getElementsByTagName('textarea').innerText =decodeUnicode(e);
                <!--document.execCommand('copy');-->
            }
        }
    }
    //state change
    guac.onstatechange = function(state){
        if (state == 5){
            //alert closed
            //var STATE_IDLE          = 0;
            //var STATE_CONNECTING    = 1;
            //var STATE_WAITING       = 2;
            //var STATE_CONNECTED     = 3;
            //var STATE_DISCONNECTING = 4;
            //var STATE_DISCONNECTED  = 5;

            swal({
              title: 'Your connection has been lost or killed!',
              text: "Do you want to reconnect！",
              type: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Reconnect',
              cancelButtonText: 'Cancel'
            }).then((result) => {
              if (result.value) {
                document.location.reload();
              }
            })

        }
    }

    // Mouse
    var mouse = new Guacamole.Mouse(guac.getDisplay().getElement());

    mouse.onmousedown =
    mouse.onmouseup   =
    mouse.onmousemove = function(mouseState) {
        guac.sendMouseState(mouseState);
    };

    // Keyboard
    var keyboard = new Guacamole.Keyboard(document);

    keyboard.onkeydown = function (keysym) {
        guac.sendKeyEvent(1, keysym);
    };


keyboard.onkeyup = function (keysym) {
        guac.sendKeyEvent(0, keysym);
    };

function sendString(client, str) {
    for (var i=0; i < str.length; i++) {
        var codepoint = str.charCodeAt(i);
        var keysym;
        if (codepoint >= 0x0100)
            keysym = 0x01000000 | codepoint;
        else
            keysym = codepoint;
        client.sendKeyEvent(1, keysym);
        <!--client.sendKeyEvent(0, keysym);-->

    }

}

Mousetrap.bind('ctrl+shift+alt', function(e) {
    var data = document.getElementsByTagName('textarea').innerText;
    if (data == undefined){
        data = ''
    }
    swal({
      title: 'clipboard',
      input: 'textarea',
      confirmButtonText: 'paste data',
      inputValue: data,
    }).then(function(text) {
        //console.log('copy data',text.value);
        //sendString(guac,text.value)
        <!--guac.setClipboard = text.value;-->
        //guac.sendkeys("Ctrl+V");
        var data = text.value;
        <!--var stream = guac.createClipboardStream("text/plain");-->
        <!--var writer = new Guacamole.StringWriter(stream);-->
        //console.log(2,guac.setClipboard)
        if (data != undefined){
            //console.log('set clipboard');
            //console.log('data',data);
            <!--sendString(guac,data);-->
            var stream = guac.createClipboardStream("text/plain");
            var writer = new Guacamole.StringWriter(stream);

            // Send text chunks
            for (var i = 0; i < data.length; i += 4096)
            writer.sendText(data.substring(i, i + 4096));

            // Close stream
            writer.sendEnd();
            guac.setClipboard(data);
        }

    })
});
var textarea = document.createElement("textarea");
textarea.textContent = '';
textarea.style.display = "none";  // Prevent scrolling to bottom of page in MS Edge.
textarea.setAttribute('id','textarea');
document.body.appendChild(textarea);
textarea.select();
/* ]]> */ </script>
</body>
</html>